pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Test') {
            steps {
                script {
                    // Executar testes no contêiner da aplicação Flask
                    sh 'docker-compose exec flask-app pytest tests'
                }
            }
        }

        stage('Descobrir caminho da tabela') {
            steps {
                script {
                    // Execute o comando 'ls' para listar o conteúdo do diretório
                    sh 'ls -R /app'
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    // Subir os serviços definidos no docker-compose
                    sh 'docker-compose up -d'

                    // Aguardar até que o MySQL e o Redis estejam prontos
                    sh 'docker-compose exec flask-app wait-for-it.sh mysql-db:3306 --timeout=60 --strict -- echo "MySQL is up"'
                    sh 'docker-compose exec flask-app wait-for-it.sh redis:6379 --timeout=60 --strict -- echo "Redis is up"'
                }
            }
        }

        stage('Database Setup') {
            steps {
                script {
                    // Executar as migrações no contêiner da aplicação Flask
                    try {
                        sh 'docker-compose exec flask-app flask db upgrade'
                    } catch (Exception e) {
                        echo "Erro durante a execução do Database Setup: ${e.message}"
                        currentBuild.result = 'FAILURE'
                        error "Erro durante a execução do Database Setup"
                    }
                }
            }
        }

        stage('Email') {
            steps {
                script {
                    // Enviar e-mail com a tabela do SQL
                    emailext (
                        subject: "Resultados dos testes com Tabela SQL",
                        body: '''<p>Olá,</p>
                                <p>Os resultados dos testes do aplicativo foram bem-sucedidos.</p>
                                <p>Anexei a tabela de resultados dos testes do SQL.</p>
                                <p>Atenciosamente,<br/>
                                [Seu nome]</p>''',
                        to: "luca.felipe@ges.inatel.br",
                        mimeType: 'text/html',
                        attachmentsPattern: '/app/tabela.sql'
                    )
                }
            }
        }
    }

    post {
        always {
            // Limpar os contêineres e volumes após a execução
            sh 'docker-compose down -v'
        }
    }
}
