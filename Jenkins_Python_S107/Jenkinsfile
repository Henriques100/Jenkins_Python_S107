pipeline {
    agent {
        docker {
            image 'jenkins/jenkins'
        }
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Set up Python') {
            steps {
                script {
                    sh 'apt-get update && apt-get install -y python3'
                }
            }
        }


        stage('Build') {
            steps {
                script {
                    // Instalar dependências do Python
                    sh 'apt-get update && apt-get install -y python3-venv'
                    sh 'python3 -m venv venv'
                    sh 'source venv/bin/activate && pip install -r requirements/dev.txt'
                }
            }
        }

        stage('Test') {
            steps {
                script {
                    // Executar testes
                    sh 'source venv/bin/activate && python3 testing.py'

                    // Gerar artefato de teste (exemplo: um arquivo de log)
                    sh 'cp test_results.log ${WORKSPACE}/test_results.log'
                }
            }
        }

        stage('Notifications') {
            steps {
                script {
                    echo 'Notificação'
                    echo 'Enviando e-mail para luca.felipe@ges.inatel.br...'
                    echo 'Enviando mensagem para o canal Slack...'
                    emailext subject: "Resultados dos Testes: ${currentBuild.result}",
                              body: 'Veja os resultados dos testes na console de build.',
                              to: 'luca.felipe@ges.inatel.br',
                              replyTo: '$DEFAULT_REPLYTO',
                              mimeType: 'text/html'
                }
            }
        }
    }

    post {
        failure {
            emailext subject: 'Build Failed',
                      body: 'O build falhou. Veja a console de build para mais detalhes.',
                      to: 'luca.felipe@ges.inatel.br'
        }
    }
}
